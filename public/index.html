<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Character Generator – Library of Calabria</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&display=swap">
  <link rel="stylesheet" href="/assets/css/dist/core.css">
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    /* ── Design tokens ─────────────────────────────────── */
    :root {
      --bg:          #1a1714;
      --surface:     #242019;
      --surface-2:   #2d2820;
      --gold:        #c9a84c;
      --gold-light:  #e5c97a;
      --gold-dark:   #a8822a;
      --gold-border: rgba(201,168,76,0.28);
      --gold-glow:   rgba(201,168,76,0.12);
      --text:        #e8dcc4;
      --text-muted:  #9a8a6a;
      --text-dim:    #5a4f3a;
      --error:       #d9534f;
    }

    /* ── Base ──────────────────────────────────────────── */
    body {
      margin:      0;
      font-family: 'Crimson Pro', Georgia, serif;
      background:  var(--bg);
      color:       var(--text);
      min-height:  100vh;
      /* Subtle diamond trellis pattern */
      background-image: url("data:image/svg+xml,%3Csvg width='48' height='48' viewBox='0 0 48 48' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M24 2L46 24L24 46L2 24Z' fill='none' stroke='%23c9a84c' stroke-width='0.4' stroke-opacity='0.12'/%3E%3C/svg%3E");
    }

    /* ── Shared button styles ───────────────────────────── */
    .btn {
      display:       inline-flex;
      align-items:   center;
      justify-content: center;
      gap:           0.5rem;
      padding:       0.6rem 1.4rem;
      font-family:   'Cinzel', Georgia, serif;
      font-size:     0.82rem;
      font-weight:   600;
      letter-spacing:0.06em;
      border-radius: 5px;
      cursor:        pointer;
      transition:    all 0.2s;
      text-transform:uppercase;
    }

    .btn-gold {
      background:    linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 50%, var(--gold-dark) 100%);
      color:         #1a1410;
      border:        1px solid var(--gold-dark);
      box-shadow:    0 2px 8px rgba(201,168,76,0.25);
    }

    .btn-gold:hover:not(:disabled) {
      background:    linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%);
      box-shadow:    0 4px 16px rgba(201,168,76,0.35);
      transform:     translateY(-1px);
    }

    .btn-gold:disabled {
      opacity: 0.5;
      cursor:  not-allowed;
      transform: none;
    }

    .btn-ghost {
      background:    transparent;
      color:         var(--text-muted);
      border:        1px solid rgba(201,168,76,0.2);
      font-family:   'Cinzel', Georgia, serif;
      font-size:     0.75rem;
      letter-spacing:0.05em;
      padding:       0.4rem 0.9rem;
      border-radius: 4px;
      cursor:        pointer;
      text-transform:uppercase;
      transition:    all 0.2s;
    }

    .btn-ghost:hover {
      color:        var(--gold-light);
      border-color: var(--gold-border);
    }

    .btn-outline {
      background:    transparent;
      color:         var(--gold);
      border:        1px solid var(--gold-border);
      font-family:   'Cinzel', Georgia, serif;
      font-size:     0.82rem;
      letter-spacing:0.06em;
      padding:       0.6rem 1.4rem;
      border-radius: 5px;
      cursor:        pointer;
      text-transform:uppercase;
      transition:    all 0.2s;
    }

    .btn-outline:hover {
      background:   var(--gold-glow);
      border-color: var(--gold);
      color:        var(--gold-light);
    }

    /* ── Auth screen ────────────────────────────────────── */
    #cg-auth-screen {
      display:         flex;
      align-items:     center;
      justify-content: center;
      min-height:      100vh;
      padding:         2rem;
    }

    .auth-card {
      background:    var(--surface);
      border:        1px solid var(--gold-border);
      border-radius: 12px;
      padding:       0 2rem 2.5rem;
      width:         100%;
      max-width:     400px;
      box-shadow:    0 24px 64px rgba(0,0,0,0.5), 0 0 0 1px rgba(201,168,76,0.1);
      overflow:      hidden;
    }

    .auth-card-accent {
      height:     3px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
      margin:     0 -2rem 2.5rem;
    }

    .auth-emblem {
      text-align:    center;
      font-family:   'Cinzel', Georgia, serif;
      font-size:     1.5rem;
      color:         var(--gold);
      letter-spacing:0.12em;
      margin-bottom: 0.35rem;
      line-height:   1;
    }

    .auth-card h1 {
      margin:        0 0 0.2rem;
      font-family:   'Cinzel', Georgia, serif;
      font-size:     1.5rem;
      font-weight:   700;
      color:         var(--gold-light);
      text-align:    center;
      letter-spacing:0.06em;
    }

    .auth-card .subtitle {
      text-align:    center;
      color:         var(--text-muted);
      font-size:     0.9rem;
      font-family:   'Cinzel', Georgia, serif;
      letter-spacing:0.1em;
      text-transform:uppercase;
      margin-bottom: 2rem;
    }

    .auth-divider {
      height:     1px;
      background: linear-gradient(90deg, transparent, var(--gold-border), transparent);
      margin:     0 -2rem 1.75rem;
    }

    .auth-tabs {
      display:       flex;
      border-bottom: 1px solid rgba(201,168,76,0.15);
      margin-bottom: 1.5rem;
    }

    .auth-tab {
      flex:          1;
      background:    none;
      border:        none;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      color:         var(--text-dim);
      padding:       0.5rem;
      font-family:   'Cinzel', Georgia, serif;
      font-size:     0.8rem;
      font-weight:   600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      cursor:        pointer;
      transition:    all 0.2s;
    }

    .auth-tab.active {
      color:             var(--gold);
      border-bottom-color: var(--gold);
    }

    .auth-tab:hover:not(.active) {
      color: var(--text-muted);
    }

    .auth-form { display: none; flex-direction: column; gap: 1rem; }
    .auth-form.active { display: flex; }

    .auth-field label {
      font-family:   'Cinzel', Georgia, serif;
      font-size:     0.72rem;
      font-weight:   600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:         var(--text-muted);
      display:       block;
      margin-bottom: 0.4rem;
    }

    .auth-field input {
      width:         100%;
      padding:       0.65rem 0.9rem;
      background:    rgba(10,8,5,0.5);
      border:        1px solid rgba(201,168,76,0.18);
      border-radius: 5px;
      color:         var(--text);
      font-family:   'Crimson Pro', Georgia, serif;
      font-size:     1rem;
      outline:       none;
      transition:    border-color 0.2s, box-shadow 0.2s;
    }

    .auth-field input:focus {
      border-color: var(--gold);
      box-shadow:   0 0 0 2px rgba(201,168,76,0.12);
    }

    .auth-field input::placeholder {
      color: var(--text-dim);
    }

    .auth-submit {
      width:      100%;
      padding:    0.8rem;
      margin-top: 0.25rem;
    }

    .auth-error {
      color:      var(--error);
      font-size:  0.9rem;
      text-align: center;
      min-height: 1.2em;
      font-style: italic;
    }

    /* ── App screen ─────────────────────────────────────── */
    #cg-app-screen {
      display:    none;
      min-height: 100vh;
      flex-direction: column;
    }

    .app-header {
      display:         flex;
      align-items:     center;
      justify-content: space-between;
      padding:         0.9rem 2rem;
      background:      var(--surface);
      border-bottom:   1px solid var(--gold-border);
      box-shadow:      0 2px 16px rgba(0,0,0,0.3);
      position:        sticky;
      top:             0;
      z-index:         100;
    }

    .app-header__brand {
      display:     flex;
      align-items: center;
      gap:         0.85rem;
    }

    .app-header__emblem {
      font-size:  1.3rem;
      color:      var(--gold);
      line-height:1;
    }

    .app-header__title {
      font-family:   'Cinzel', Georgia, serif;
      font-size:     1.1rem;
      font-weight:   700;
      color:         var(--gold-light);
      letter-spacing:0.05em;
      margin:        0;
      line-height:   1.2;
    }

    .app-header__sub {
      display:       block;
      font-family:   'Cinzel', Georgia, serif;
      font-size:     0.65rem;
      color:         var(--text-dim);
      letter-spacing:0.12em;
      text-transform:uppercase;
    }

    .app-header__user {
      display:     flex;
      align-items: center;
      gap:         1rem;
    }

    .app-header__username {
      font-size:  0.9rem;
      color:      var(--text-muted);
    }

    .app-header__username strong {
      color:      var(--text);
      font-weight:600;
    }

    /* ── App main content ───────────────────────────────── */
    .app-main {
      flex:            1;
      display:         flex;
      align-items:     center;
      justify-content: center;
      padding:         3rem 2rem;
    }

    .app-hero {
      text-align: center;
      max-width:  480px;
    }

    .app-hero__ornament {
      font-size:     2rem;
      color:         var(--gold);
      display:       block;
      margin-bottom: 1rem;
      opacity:       0.7;
    }

    .app-hero__title {
      font-family:   'Cinzel', Georgia, serif;
      font-size:     2rem;
      font-weight:   700;
      color:         var(--gold-light);
      letter-spacing:0.05em;
      margin:        0 0 0.4rem;
      line-height:   1.2;
    }

    .app-hero__subtitle {
      font-family:   'Cinzel', Georgia, serif;
      font-size:     0.8rem;
      color:         var(--text-muted);
      letter-spacing:0.15em;
      text-transform:uppercase;
      margin:        0 0 2rem;
    }

    .app-hero__rule {
      height:        1px;
      background:    linear-gradient(90deg, transparent, var(--gold-border), transparent);
      margin:        0 auto 2.5rem;
      width:         80%;
    }

    .app-hero__cta {
      padding:    0.9rem 2.5rem;
      font-size:  0.9rem;
    }

    /* ── The builder button (hidden visually but kept for JS) ── */
    #cg-open-builder-trigger {
      display: none;
    }

    /* ── Splash + builder modals inherit from core.css ─── */
    /* Button overrides within the bundle-generated UI */
    .button,
    .button.primary,
    .button.secondary {
      display:       inline-flex;
      align-items:   center;
      justify-content: center;
      font-family:   'Cinzel', Georgia, serif;
      font-size:     0.78rem;
      font-weight:   600;
      letter-spacing:0.06em;
      text-transform:uppercase;
      border-radius: 5px;
      padding:       0.55rem 1.2rem;
      cursor:        pointer;
      transition:    all 0.18s;
      border:        1px solid var(--gold-border);
      background:    linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 50%, var(--gold-dark) 100%);
      color:         #1a1410;
      box-shadow:    0 2px 6px rgba(201,168,76,0.2);
    }

    .button:hover,
    .button.primary:hover {
      background:  linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%);
      box-shadow:  0 4px 12px rgba(201,168,76,0.3);
      transform:   translateY(-1px);
    }

    .button.secondary {
      background:   transparent;
      color:        var(--gold);
      border-color: var(--gold-border);
      box-shadow:   none;
    }

    .button.secondary:hover {
      background:  rgba(201,168,76,0.08);
      color:       var(--gold-light);
      border-color:var(--gold);
    }

    /* unsaved dialog buttons */
    .unsaved-dialog {
      font-family: 'Crimson Pro', Georgia, serif;
    }

    .unsaved-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

<!-- ── Auth Screen ───────────────────────────────────────────── -->
<div id="cg-auth-screen" style="display:flex">
  <div class="auth-card">
    <div class="auth-card-accent"></div>

    <div class="auth-emblem">◆</div>
    <h1>Library of Calabria</h1>
    <p class="subtitle">Character Generator</p>

    <div class="auth-divider"></div>

    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">Sign In</button>
      <button class="auth-tab" data-tab="register">Register</button>
    </div>

    <form class="auth-form active" id="login-form" onsubmit="return false;">
      <div class="auth-field">
        <label for="login-username">Username or Email</label>
        <input type="text" id="login-username" name="username" autocomplete="username" placeholder="Enter your username">
      </div>
      <div class="auth-field">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" name="password" autocomplete="current-password" placeholder="Enter your password">
      </div>
      <div class="auth-error" id="login-error"></div>
      <button type="button" id="login-btn" class="btn btn-gold auth-submit">Sign In</button>
    </form>

    <form class="auth-form" id="register-form" onsubmit="return false;">
      <div class="auth-field">
        <label for="reg-username">Username</label>
        <input type="text" id="reg-username" name="username" autocomplete="username" placeholder="Choose a username">
      </div>
      <div class="auth-field">
        <label for="reg-email">Email</label>
        <input type="email" id="reg-email" name="email" autocomplete="email" placeholder="your@email.com">
      </div>
      <div class="auth-field">
        <label for="reg-password">Password</label>
        <input type="password" id="reg-password" name="password" autocomplete="new-password" placeholder="Choose a password">
      </div>
      <div class="auth-error" id="register-error"></div>
      <button type="button" id="register-btn" class="btn btn-gold auth-submit">Create Account</button>
    </form>
  </div>
</div>

<!-- ── App Screen ────────────────────────────────────────────── -->
<div id="cg-app-screen" style="display:none; flex-direction:column; min-height:100vh">

  <header class="app-header">
    <div class="app-header__brand">
      <span class="app-header__emblem">◆</span>
      <div>
        <h1 class="app-header__title">Library of Calabria</h1>
        <span class="app-header__sub">Character Generator</span>
      </div>
    </div>
    <div class="app-header__user">
      <span class="app-header__username">Signed in as <strong id="cg-username-display"></strong></span>
      <button class="btn-ghost" id="cg-logout-btn">Sign Out</button>
    </div>
  </header>

  <main class="app-main">
    <div class="app-hero">
      <span class="app-hero__ornament">✦ ◆ ✦</span>
      <h2 class="app-hero__title">Your Characters</h2>
      <p class="app-hero__subtitle">Library of Calabria &mdash; Character Records</p>
      <div class="app-hero__rule"></div>
      <button id="cg-open-builder" class="btn btn-gold app-hero__cta">
        ✦ &nbsp; Open Character Builder
      </button>
    </div>
  </main>

  <!-- Splash modal (New / Load) — shown by bundle JS -->
  <div id="cg-modal-splash" class="cg-modal-splash cg-hidden">
    <div class="cg-modal-splash__content">
      <h2>Character Builder</h2>
      <p style="color:var(--text-muted);font-family:'Crimson Pro',Georgia,serif;font-size:0.95rem;margin:0 0 1.5rem">Begin a new tale or continue an existing one.</p>
      <button id="cg-new-splash" class="button primary">✦ &nbsp; New Character</button>
      <div class="cg-splash-load">
        <label for="cg-splash-load-select">Load an existing character</label>
        <select id="cg-splash-load-select">
          <option value="">— Loading… —</option>
        </select>
        <button id="cg-load-splash" class="button">Load Character</button>
      </div>
    </div>
  </div>

  <!-- Builder modal -->
  <div id="cg-modal-overlay" class="cg-hidden">
    <div id="cg-modal">
      <button id="cg-modal-close" class="cg-modal-close">✕</button>
      <div id="cg-form-container"></div>
      <div id="cg-unsaved-confirm" class="cg-hidden">
        <div class="unsaved-dialog">
          <p>You have unsaved changes. What would you like to do?</p>
          <div class="unsaved-buttons">
            <button id="unsaved-save"   class="button primary">Save &amp; Exit</button>
            <button id="unsaved-exit"   class="button secondary">Exit Without Saving</button>
            <button id="unsaved-cancel" class="button">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ── Scripts ───────────────────────────────────────────────── -->
<script src="/vendor/jquery/dist/jquery.js"></script>
<script>
  window.CG_AJAX = {
    ajax_url:    '/api/ajax',
    ajaxurl:     '/api/ajax',
    nonce:       '1',
    security:    '1',
    _ajax_nonce: '1',
  };
  window.CG_NONCES = new Proxy({}, { get: () => '1' });
</script>

<script>
(function () {
  const authScreen = document.getElementById('cg-auth-screen');
  const appScreen  = document.getElementById('cg-app-screen');

  async function ajax(action, data) {
    const body = new URLSearchParams({ action, nonce: '1', security: '1', ...data });
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 10000);
    try {
      const r = await fetch('/api/ajax', { method: 'POST', body, signal: controller.signal });
      clearTimeout(timer);
      return r.json();
    } catch (e) {
      clearTimeout(timer);
      return { success: false, data: e.name === 'AbortError' ? 'Request timed out.' : 'Network error.' };
    }
  }

  function showAuth() {
    authScreen.style.display = 'flex';
    appScreen.style.display  = 'none';
  }

  function showApp(username) {
    authScreen.style.display = 'none';
    appScreen.style.display  = 'flex';
    document.getElementById('cg-username-display').textContent = username;
    loadBundle();
  }

  async function init() {
    try {
      const controller = new AbortController();
      setTimeout(() => controller.abort(), 4000);
      const r = await fetch('/api/auth/me', { signal: controller.signal });
      const d = await r.json();
      if (d.success) showApp(d.data.username);
    } catch (e) {}
  }

  document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab + '-form').classList.add('active');
    });
  });

  async function doLogin() {
    const btn      = document.getElementById('login-btn');
    const err      = document.getElementById('login-error');
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    if (!username || !password) { err.textContent = 'Please enter your username and password.'; return; }
    btn.disabled = true;
    err.textContent = 'Signing in…';
    const res = await ajax('cg_login_user', { username, password });
    btn.disabled = false;
    if (res.success) {
      err.textContent = '';
      showApp(username);
    } else {
      err.textContent = res.data || 'Login failed.';
    }
  }

  async function doRegister() {
    const btn      = document.getElementById('register-btn');
    const err      = document.getElementById('register-error');
    const username = document.getElementById('reg-username').value.trim();
    const email    = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;
    if (!username || !email || !password) { err.textContent = 'All fields are required.'; return; }
    btn.disabled = true;
    err.textContent = 'Creating account…';
    const res = await ajax('cg_register_user', { username, email, password });
    btn.disabled = false;
    if (res.success) {
      err.textContent = '';
      showApp(username);
    } else {
      err.textContent = res.data || 'Registration failed.';
    }
  }

  window.doLogin    = doLogin;
  window.doRegister = doRegister;

  document.getElementById('login-btn').addEventListener('click', doLogin);
  document.getElementById('login-username').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
  document.getElementById('login-password').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
  document.getElementById('register-btn').addEventListener('click', doRegister);

  document.getElementById('cg-logout-btn').addEventListener('click', async () => {
    await ajax('cg_logout_user', {});
    showAuth();
  });

  let bundleLoaded = false;
  function loadBundle() {
    if (bundleLoaded) return;
    bundleLoaded = true;
    const s = document.createElement('script');
    s.src = '/assets/js/dist/core.bundle.js';
    document.body.appendChild(s);
  }

  init();
})();
</script>
</body>
</html>
